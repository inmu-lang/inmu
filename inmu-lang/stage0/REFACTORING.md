# アーキテクチャ共通化プロジェクト完了報告

## 実施内容

ARM64とx86_64の2つのアーキテクチャのアセンブリコードを、共通ロジックとアーキテクチャ固有実装に分離しました。

## 新しいディレクトリ構造

```
stage0/src/
├── common/                     # 共通ロジック（ドキュメント形式）
│   ├── README.md              # 共通化の概要
│   ├── algorithm.md           # 全体アルゴリズム
│   ├── constants.md           # 定数定義
│   ├── parser.md              # パーサーロジック
│   ├── expression.md          # 式評価ロジック
│   ├── variables.md           # 変数管理ロジック
│   └── control.md             # 制御構造ロジック
│
├── arch/                       # アーキテクチャ固有実装
│   ├── arm64/                 # Apple Silicon 実装
│   │   ├── main.s
│   │   └── include/
│   │       ├── print.s
│   │       ├── variables.s
│   │       ├── expression.s
│   │       └── control.s
│   │
│   └── x86_64/                # Intel Mac 実装
│       ├── main.s
│       └── include/
│           ├── print.s
│           ├── variables.s
│           ├── expression.s
│           └── control.s
│
└── mac/                        # 旧構造（後方互換性のため残存）
    ├── arm64/...
    └── x86_64/...
```

## 共通化の方法

### 1. ロジックの文書化
すべてのアルゴリズムとロジックを Markdown ドキュメントとして `src/common/` に文書化：

- **algorithm.md**: システム全体の実行フロー
- **parser.md**: トークン解析とパースロジック
- **expression.md**: 式評価の再帰下降パーサー
- **variables.md**: 変数テーブルの管理方法
- **control.md**: if/else/endif の制御フロー
- **constants.md**: システムコール番号などの定数

### 2. アーキテクチャ固有実装の分離
実際のアセンブリコードは `src/arch/{ARCH}/` に配置：

- ARM64: レジスタ (x0-x30)、命令 (stp, ldp, bl)、システムコール (svc #0x80)
- x86_64: レジスタ (rax, rdi, rsi)、命令 (pushq, call)、システムコール (syscall)

### 3. ビルドシステムの更新
- Makefile を新しいパス (`src/arch/{ARCH}/main.s`) に更新
- 両アーキテクチャで同じビルドプロセスを維持

## 利点

### 1. 保守性の向上
- ロジックが文書化されているため、理解しやすい
- アルゴリズムの変更時に両アーキテクチャで同じ変更を適用しやすい

### 2. ドキュメントとしての価値
- アルゴリズムが言語非依存の形式で記述されている
- 新しいアーキテクチャへの移植が容易
- 教育資料としても使用可能

### 3. Stage 1 への移行準備
- ロジックが明確に定義されているため、INMU言語での実装が容易
- インターフェースが統一されている

## 検証結果

✅ ビルド成功: ARM64
✅ 全テストパス: 28/28
✅ 後方互換性: 既存のコードは `src/mac/` に残存

## 今後の作業

1. **旧ディレクトリの削除**: `src/mac/` を削除（確認後）
2. **追加ドキュメント**: print.md などの追加モジュールドキュメント
3. **Stage 1 実装**: 共通ロジックを参照して INMU 言語で実装

## ファイル数

- 共通ドキュメント: 7ファイル
- ARM64 実装: 5ファイル (.s)
- x86_64 実装: 5ファイル (.s)

合計: 17ファイル（旧構造を除く）
